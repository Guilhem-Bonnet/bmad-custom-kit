$schema: "bmad-archetype-dna/v1"

id: stack/docker
name: "Stack ‚Äî Docker Expert"
version: "1.0.0"
description: "Agent sp√©cialis√© Docker ‚Äî multi-stage builds, s√©curit√© images, Compose, healthchecks"
icon: "üêã"
author: "bmad-custom-kit"
tags: [docker, containers, compose, registry, security, multi-stage]

inherits: minimal

traits:
  - name: multi-stage-builds
    description: "Builds Docker multi-stage pour images l√©g√®res"
    rule: "Tout Dockerfile de production utilise le multi-stage build. Image finale FROM distroless ou alpine. Jamais garder les outils de build dans l'image finale."
    agents_affected: [docker-expert]
    acceptance_criteria:
      - id: multi-stage-required
        description: "Les Dockerfiles de production ont au moins 2 stages (build + runtime)"
        enforcement: soft
        context: "R√©duction de la taille d'image + surface d'attaque"
        triggers_on: ["**/Dockerfile*"]
  - name: no-root-container
    description: "Les conteneurs tournent en utilisateur non-root"
    rule: "Tout Dockerfile d√©clare USER non-root avant CMD/ENTRYPOINT. Utiliser --cap-drop ALL + --cap-add si besoin de capabilities."
    agents_affected: [docker-expert]
    acceptance_criteria:
      - id: non-root-user
        description: "Le Dockerfile d√©clare un USER non-root (pas uid 0) avant l'instruction CMD"
        enforcement: hard
        context: "S√©curit√© des conteneurs en production"
        triggers_on: ["**/Dockerfile*"]
  - name: healthcheck-mandatory
    description: "Tous les services Docker Compose ont un healthcheck"
    rule: "Chaque service dans docker-compose.yml avec un port expos√© d√©clare un healthcheck HEALTHCHECK CMD. Les services d√©pendants utilisent depends_on avec condition: service_healthy."
    agents_affected: [docker-expert]
    acceptance_criteria:
      - id: healthcheck-declared
        description: "Chaque service expos√© dans Compose a une instruction HEALTHCHECK"
        enforcement: soft
        context: "Ordonnancement fiable des services + monitoring"
        triggers_on: ["**/docker-compose*.yml", "**/docker-compose*.yaml"]

tools_required:
  - name: docker
    description: "Docker Engine ou Docker Desktop"
    required: true
    check_command: "which docker"
  - name: docker-compose
    description: "Docker Compose v2 (plugin ou standalone)"
    required: false
    check_command: "docker compose version || which docker-compose"
  - name: hadolint
    description: "Linter Dockerfile"
    required: false
    check_command: "which hadolint"

acceptance_criteria:
  - id: hadolint-pass
    description: "hadolint Dockerfile retourne 0 warnings de niveau ‚â• warning"
    enforcement: soft
    context: "Best practices Dockerfile"
    triggers_on: ["**/Dockerfile*"]
    checked_by: docker-expert
  - id: image-builds-clean
    description: "docker build . termine sans erreur sur la branche courante"
    enforcement: hard
    context: "Build reproductible"
    triggers_on: ["**/Dockerfile*"]
    checked_by: docker-expert

compatible_with: [minimal, web-app, infra-ops, fix-loop, stack/go, stack/python, stack/typescript, stack/k8s]
incompatible_with: []
