$schema: "bmad-archetype-dna/v1"

id: stack/go
name: "Stack ‚Äî Go Expert"
version: "1.0.0"
description: "Agent sp√©cialis√© Go ‚Äî backend performant, tests table-driven, gestion des goroutines"
icon: "üêπ"
author: "bmad-custom-kit"
tags: [go, golang, backend, api, grpc, performance, concurrency]

inherits: minimal

traits:
  - name: table-driven-tests
    description: "Tests Go en style table-driven obligatoires"
    rule: "Tout test Go utilise des table-driven tests avec []struct{name, input, expected}. Z√©ro test r√©p√©t√© sans table."
    agents_affected: [go-expert]
    acceptance_criteria:
      - id: table-driven-style
        description: "Les tests Go sont structur√©s en table-driven ([]struct avec name/input/expected)"
        enforcement: hard
        context: "Pattern Go idiomatique ‚Äî √©vite la duplication"
        triggers_on: ["**/*_test.go"]
  - name: error-wrapping
    description: "Erreurs wrapp√©es avec contexte via fmt.Errorf"
    rule: "Toute erreur retourn√©e utilise fmt.Errorf(\"context: %w\", err). Jamais return err sans contexte sauf au niveau top."
    agents_affected: [go-expert]
    acceptance_criteria:
      - id: errors-wrapped
        description: "Les erreurs sont wrapp√©es avec fmt.Errorf et %w pour pr√©server la cha√Æne"
        enforcement: soft
        context: "Permet errors.Is/As en amont"
        triggers_on: ["**/*.go"]
  - name: no-goroutine-leak
    description: "Z√©ro goroutine leak ‚Äî chaque goroutine a un m√©canisme de fin"
    rule: "Toute goroutine lanc√©e doit avoir : context.Context pour l'annulation, ou sync.WaitGroup, ou channel de done. Jamais go func() sans m√©canisme de terminaison."
    agents_affected: [go-expert]
    acceptance_criteria:
      - id: goroutine-cancellation
        description: "Toute goroutine re√ßoit un context.Context ou a un m√©canisme d'arr√™t explicite"
        enforcement: hard
        context: "Pr√©vention des goroutine leaks en production"
        triggers_on: ["**/*.go"]

tools_required:
  - name: go
    description: "Compilateur Go (>= 1.21 recommand√©)"
    required: true
    check_command: "which go"
  - name: golangci-lint
    description: "Linter Go multi-r√®gles"
    required: false
    check_command: "which golangci-lint"

constraints:
  - id: no-global-state
    description: "Pas de variables globales mutables ‚Äî passer par injection de d√©pendances"
    enforcement: soft
    checked_by: go-expert
  - id: interfaces-small
    description: "Les interfaces Go ont ‚â§ 3 m√©thodes (principe de s√©gr√©gation)"
    enforcement: soft
    checked_by: go-expert

acceptance_criteria:
  - id: go-vet-pass
    description: "go vet ./... passe sans warnings avant tout commit"
    enforcement: hard
    context: "V√©rification statique Go natif"
    triggers_on: ["**/*.go"]
    checked_by: go-expert
  - id: go-test-pass
    description: "go test ./... -race passe avec le race detector activ√©"
    enforcement: hard
    context: "D√©tection des data races en CI"
    triggers_on: ["**/*.go"]
    checked_by: go-expert

compatible_with: [minimal, web-app, fix-loop, stack/docker, stack/k8s]
incompatible_with: []
