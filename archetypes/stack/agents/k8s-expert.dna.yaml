$schema: "bmad-archetype-dna/v1"

id: stack/k8s
name: "Stack — Kubernetes Expert"
version: "1.0.0"
description: "Agent spécialisé Kubernetes — workloads, RBAC, troubleshooting, K3s, Helm, FluxCD"
icon: "⎈"
author: "bmad-custom-kit"
tags: [kubernetes, k8s, k3s, helm, fluxcd, rbac, gitops, workloads]

inherits: minimal

traits:
  - name: resource-limits-mandatory
    description: "Chaque Pod déclare des resource requests et limits"
    rule: "Tout manifest Deployment/StatefulSet/DaemonSet déclare resources.requests et resources.limits sur chaque conteneur. Zéro pod sans limits en production."
    agents_affected: [k8s-expert]
    acceptance_criteria:
      - id: resource-limits-set
        description: "Chaque container dans un workload déclare resources.requests.cpu, resources.requests.memory, resources.limits.memory"
        enforcement: hard
        context: "Stabilité du cluster — évite les OOMKill inattendus"
        triggers_on: ["**/k8s/**/*.yaml", "**/manifests/**/*.yaml"]
  - name: rbac-least-privilege
    description: "RBAC avec principe du moindre privilège"
    rule: "Chaque ServiceAccount a uniquement les verbes/ressources nécessaires. Zéro ClusterAdmin pour les workloads applicatifs. Documenter pourquoi si élévation nécessaire."
    agents_affected: [k8s-expert]
    acceptance_criteria:
      - id: no-clusteradmin-workloads
        description: "Aucun workload applicatif ne lie un ServiceAccount à ClusterAdmin"
        enforcement: hard
        context: "Sécurité K8s fondamentale"
        triggers_on: ["**/ClusterRoleBinding*.yaml", "**/k8s/**/*.yaml"]
  - name: readiness-liveness-probes
    description: "Probes de santé sur tous les Deployments"
    rule: "Chaque Deployment déclare readinessProbe ET livenessProbe. Sans readinessProbe, le load-balancer envoie du trafic à des pods non-prêts."
    agents_affected: [k8s-expert]
    acceptance_criteria:
      - id: probes-declared
        description: "Chaque Deployment a readinessProbe et livenessProbe configurées"
        enforcement: soft
        context: "Disponibilité et auto-healing"
        triggers_on: ["**/Deployment*.yaml", "**/k8s/**/*.yaml"]

tools_required:
  - name: kubectl
    description: "CLI Kubernetes"
    required: true
    check_command: "which kubectl"
  - name: helm
    description: "Package manager Kubernetes"
    required: false
    check_command: "which helm"
  - name: kustomize
    description: "Overlay de configuration K8s"
    required: false
    check_command: "which kustomize"
  - name: kubeval
    description: "Validation des manifests K8s"
    required: false
    check_command: "which kubeval || which kubeconform"

acceptance_criteria:
  - id: manifests-valid
    description: "kubeconform/kubeval valide tous les manifests sans erreur de schéma"
    enforcement: soft
    context: "Validates K8s API schema compliance"
    triggers_on: ["**/k8s/**/*.yaml", "**/manifests/**/*.yaml"]
    checked_by: k8s-expert
  - id: dry-run-pass
    description: "kubectl apply --dry-run=server ne retourne pas d'erreur"
    enforcement: hard
    context: "Validation server-side avant apply réel"
    triggers_on: ["**/k8s/**/*.yaml"]
    checked_by: k8s-expert

compatible_with: [minimal, infra-ops, fix-loop, stack/docker, stack/terraform]
incompatible_with: []
