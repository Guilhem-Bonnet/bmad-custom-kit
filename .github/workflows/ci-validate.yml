name: BMAD CI — Validate

on:
  push:
    branches: [main, "bmad/**"]
    paths:
      - "archetypes/**"
      - "framework/**"
      - "bmad-init.sh"
      - ".github/workflows/ci-validate.yml"
  pull_request:
    branches: [main]
    paths:
      - "archetypes/**"
      - "framework/**"
      - "bmad-init.sh"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── 1. Syntaxe bash ─────────────────────────────────────────────────────────
  bash-syntax:
    name: "Bash syntax check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check bmad-init.sh syntax
        run: bash -n bmad-init.sh && echo "✅ bmad-init.sh OK"

      - name: Check all hook scripts syntax
        run: |
          find framework/hooks -name "*.sh" | while read -r f; do
            bash -n "$f" && echo "✅ $f OK" || { echo "❌ $f FAIL"; exit 1; }
          done

  # ── 2. DNA Validation ─────────────────────────────────────────────────────
  dna-validate:
    name: "DNA validate --all"
    runs-on: ubuntu-latest
    needs: bash-syntax
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run validate --all
        run: bash bmad-init.sh validate --all

      - name: Count DNA files
        run: |
          COUNT=$(find archetypes -name "*.dna.yaml" | wc -l)
          echo "DNA files found: $COUNT"
          echo "dna_count=$COUNT" >> $GITHUB_OUTPUT
        id: count

  # ── 3. ShellCheck ───────────────────────────────────────────────────────────
  shellcheck:
    name: "ShellCheck"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck on all shell scripts
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          severity: warning
          scandir: "."
          additional_files: "bmad-init.sh"
          ignore_paths: >-
            framework/hooks/post-checkout.sh
            framework/hooks/post-commit.sh
            _bmad

  # ── 4. YAML lint ──────────────────────────────────────────────────────────
  yaml-lint:
    name: "YAML lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_data: |
            extends: relaxed
            rules:
              line-length:
                max: 120
          file_or_dir: |
            archetypes/
            framework/
          strict: false

  # ── 5. Doctor check ───────────────────────────────────────────────────────
  doctor:
    name: "BMAD Doctor (sans Qdrant)"
    runs-on: ubuntu-latest
    needs: [bash-syntax, dna-validate]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install pyyaml

      - name: Run doctor (skip Qdrant en CI)
        run: |
          # La vérif Qdrant va échouer gracieusement en CI — on filtre les erreurs Qdrant
          bash bmad-init.sh doctor 2>&1 | tee doctor-output.txt || true
          # Vérifier qu'il n'y a pas d'erreurs críticas non-Qdrant
          CRIT=$(grep -c "✗\|FAIL\|ERROR" doctor-output.txt || true)
          QDRANT=$(grep -c "Qdrant\|qdrant" doctor-output.txt || true)
          REAL_ERRORS=$((CRIT - QDRANT))
          echo "Erreurs critiques (hors Qdrant) : $REAL_ERRORS"
          if [[ $REAL_ERRORS -gt 2 ]]; then
            echo "❌ Trop d'erreurs critiques détectées (hors Qdrant)"
            cat doctor-output.txt
            exit 1
          fi
          echo "✅ Doctor OK (hors connectivité Qdrant)"

  # ── 6. Context Budget Guard ───────────────────────────────────────────────
  context-guard:
    name: "Context Budget Guard"
    runs-on: ubuntu-latest
    needs: bash-syntax
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run context-guard (seuil alerte 40%, bloquant 70%)
        run: |
          set +e
          python3 framework/tools/context-guard.py \
            --project-root . \
            --threshold 40 \
            --json 2>&1 | tee guard-output.json
          GUARD_EXIT=${PIPESTATUS[0]}
          set -e
          if [[ "$GUARD_EXIT" -ge 2 ]]; then
            echo "❌ Context Guard CRITICAL — un agent dépasse 70% de la fenêtre"
            cat guard-output.json
            exit 2
          fi
          if [[ "$GUARD_EXIT" -eq 1 ]]; then
            echo "⚠️  Context Guard WARNING — certains agents approchent 40%"
          else
            echo "✅ Context Guard OK — tous les agents dans les limites"
          fi

      - name: Upload guard report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: context-guard-report
          path: guard-output.json
          retention-days: 14

  # ── 7. Résumé ─────────────────────────────────────────────────────────────
  summary:
    name: "CI Summary"
    runs-on: ubuntu-latest
    needs: [bash-syntax, dna-validate, shellcheck, yaml-lint, doctor, context-guard]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "## BMAD CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bash syntax | ${{ needs.bash-syntax.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DNA validate | ${{ needs.dna-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Doctor | ${{ needs.doctor.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Context Guard | ${{ needs.context-guard.result }} |" >> $GITHUB_STEP_SUMMARY
